# ====== å¥—ä»¶åŒ¯å…¥ ======
import streamlit as st                # å»ºç«‹ç¶²é ä»‹é¢çš„ä¸»å¥—ä»¶
import pandas as pd                  # è™•ç† CSV è³‡æ–™çš„å¥—ä»¶
import google.generativeai as genai  # Google Gemini AI çš„ Python å¥—ä»¶
from PIL import Image                # è™•ç†åœ–ç‰‡ï¼ˆç›®å‰æœªä½¿ç”¨ï¼‰
import requests                      # ç™¼é€ API è«‹æ±‚åŠéŒ¯èª¤è™•ç†

# ====== é é¢è¨­å®š ======
st.set_page_config(
    page_title="å°ˆé¡Œä½œæ¥­ä¸€",     # ç¶²é æ¨™é¡Œ
    page_icon="ğŸ“Š",             # æ¨™ç±¤é  icon
    layout="wide"              # å¯¬ç‰ˆç•«é¢
)

# ====== API é‡‘é‘°è¨­å®š ======
# âš ï¸ æ³¨æ„ï¼šå¯¦éš›éƒ¨ç½²æ™‚å»ºè­°ä½¿ç”¨ st.secrets æˆ– .env ç®¡ç†é‡‘é‘°
genai.configure(api_key="AIzaSyBcTohvzAeRE71-GIfCD9sfFsvYf403h8w")

# ====== å´é‚Šæ¬„ï¼šåŠŸèƒ½èˆ‡ä¸»é¡Œé¸å–® ======
with st.sidebar:
    st.header("ğŸ”§ å·¥å…·é¸å–®")
    app_mode = st.radio("é¸æ“‡åŠŸèƒ½é ", ["ğŸ“Š è³‡æ–™é›†åˆ†æ", "ğŸ¤– Gemini èŠå¤©æ©Ÿå™¨äºº"])  # åŠŸèƒ½é é¢é¸æ“‡

    st.markdown("---")
    st.header("ğŸ¨ ä¸»é¡Œè¨­å®š")
    theme = st.selectbox("é¸æ“‡ä¸»é¡Œè‰²", ["æ·ºè‰²", "æ·±è‰²"])  # é¡è‰²ä¸»é¡Œé¸æ“‡

    # å¦‚æœä½¿ç”¨è€…é¸æ“‡çš„æ˜¯è³‡æ–™é›†åˆ†æï¼Œé¡¯ç¤ºç›¸é—œè¨­å®š
    if app_mode == "ğŸ“Š è³‡æ–™é›†åˆ†æ":
        show_preview = st.checkbox("é¡¯ç¤ºè³‡æ–™é è¦½", value=True)  # æ˜¯å¦é è¦½è³‡æ–™
        num_rows = st.slider("é¡¯ç¤ºå¹¾åˆ—è³‡æ–™", min_value=5, max_value=100, value=10)  # é¡¯ç¤ºåˆ—æ•¸
        st.info("è«‹ä¸Šå‚³ CSV æª”æ¡ˆã€‚")

# ====== æ ¹æ“šä¸»é¡Œåˆ‡æ›é¡è‰²æ¨£å¼ï¼ˆå¥—ç”¨ CSSï¼‰ ======
if theme == "æ·±è‰²":
    st.markdown("""
        <style>
        .stApp { background-color: #000000; color: white; }
        section[data-testid="stSidebar"] { background-color: #111111; color: white; }
        h1, h2, h3, h4, h5, h6, p { color: white !important; }
        .dataframe th, .dataframe td { color: white !important; }
        </style>
    """, unsafe_allow_html=True)
else:
    st.markdown("""
        <style>
        .stApp { background-color: #ffffff; color: black; }
        section[data-testid="stSidebar"] { background-color: #f0f2f6; color: black; }
        </style>
    """, unsafe_allow_html=True)

# ====== ğŸ“Š åŠŸèƒ½ 1ï¼šè³‡æ–™é›†åˆ†æ ======
if app_mode == "ğŸ“Š è³‡æ–™é›†åˆ†æ":
    st.title("HW.1")  # æ¨™é¡Œ
    st.markdown("ä¸Šå‚³ä¸€å€‹ Kaggle æˆ–å…¶ä»–ä¾†æºçš„ `.csv` æª”æ¡ˆï¼Œé€²è¡Œè³‡æ–™é è¦½èˆ‡ç°¡æ˜“åˆ†æã€‚")

    # ä½¿ç”¨è€…ä¸Šå‚³æª”æ¡ˆ
    uploaded_file = st.file_uploader("ğŸ“¤ ä¸Šå‚³ä½ çš„ CSV æª”æ¡ˆ", type=["csv"])

    # å¦‚æœæœ‰ä¸Šå‚³æª”æ¡ˆ
    if uploaded_file:
        try:
            df = pd.read_csv(uploaded_file)  # å˜—è©¦è®€å– CSV æª”
            st.success("âœ… æˆåŠŸè¼‰å…¥è³‡æ–™ï¼")

            if show_preview:
                # ä¸‰å€‹é ç±¤ï¼šè³‡æ–™é è¦½ã€çµ±è¨ˆæ•¸æ“šã€æ¬„ä½ç¯©é¸
                tab1, tab2, tab3 = st.tabs(["ğŸ” è³‡æ–™é è¦½", "ğŸ“Š æ•˜è¿°çµ±è¨ˆ", "ğŸ§© æ¬„ä½ç¯©é¸"])

                with tab1:
                    st.subheader("ğŸ” é è¦½å‰å¹¾åˆ—")
                    st.dataframe(df.head(num_rows), use_container_width=True)

                with tab2:
                    st.subheader("ğŸ“Š è³‡æ–™æ•˜è¿°çµ±è¨ˆ")
                    st.write(df.describe())  # é¡¯ç¤ºçµ±è¨ˆæè¿°ï¼ˆå¹³å‡ã€æ¨™æº–å·®ç­‰ï¼‰

                with tab3:
                    st.subheader("ğŸ§© æ¬„ä½ç¯©é¸å™¨")
                    column = st.selectbox("è«‹é¸æ“‡è¦é¡¯ç¤ºçš„æ¬„ä½", df.columns)
                    st.dataframe(df[[column]].head(num_rows), use_container_width=True)

            else:
                st.warning("ğŸ“Œ è³‡æ–™å…§å®¹ç›®å‰å·²è¢«éš±è—ã€‚è«‹åœ¨å·¦å´å‹¾é¸ã€é¡¯ç¤ºè³‡æ–™é è¦½ã€æŸ¥çœ‹è³‡æ–™ã€‚")

        except Exception as e:
            # éŒ¯èª¤è™•ç†ï¼šå¦‚æœ CSV æ ¼å¼éŒ¯èª¤
            st.error(f"âŒ éŒ¯èª¤ï¼šç„¡æ³•è®€å–æª”æ¡ˆï¼Œè«‹ç¢ºèªæ ¼å¼æ­£ç¢ºã€‚\n\n{e}")
    else:
        st.warning("ğŸ“Œ è«‹ä¸Šå‚³ä¸€å€‹ `.csv` æª”æ¡ˆã€‚")

# ====== ğŸ¤– åŠŸèƒ½ 2ï¼šGemini èŠå¤©æ©Ÿå™¨äºº ======
elif app_mode == "ğŸ¤– Gemini èŠå¤©æ©Ÿå™¨äºº":
    st.title("ğŸ¤– Gemini Chatbot")
    st.markdown("è«‹è¼¸å…¥ä»»ä½•å•é¡Œï¼ŒGemini å°‡æœƒå›æ‡‰ä½ ã€‚")

    # ä½¿ç”¨è€…è¼¸å…¥å•é¡Œ
    user_input = st.text_area("âœï¸ ä½ æƒ³å• Gemini ä»€éº¼ï¼Ÿ", height=100)

    # æŒ‰ä¸‹é€å‡ºæŒ‰éˆ•
    if st.button("ğŸš€ é€å‡º"):
        if user_input.strip() == "":
            st.warning("è«‹è¼¸å…¥å•é¡Œå¾Œå†é€å‡ºã€‚")
        elif len(user_input) > 1000:
            st.warning("âš ï¸ è¼¸å…¥éé•·ï¼Œè«‹ç°¡åŒ–ä½ çš„å•é¡Œï¼ˆæœ€å¤š 1000 å­—å…ƒï¼‰ã€‚")
        else:
            with st.spinner("Gemini æ­£åœ¨ç”Ÿæˆå›æ‡‰..."):
                try:
                    # å»ºç«‹ Gemini æ¨¡å‹å¯¦ä¾‹ï¼ˆä½¿ç”¨ 1.5 Flashï¼‰
                    model = genai.GenerativeModel("models/gemini-1.5-flash")

                    # ç™¼é€å•é¡Œï¼Œä½¿ç”¨ stream å›å‚³æ–¹å¼
                    response = model.generate_content(user_input, stream=True)

                    st.success("âœ… Gemini å›æ‡‰ï¼š")
                    full_response = ""
                    for chunk in response:
                        if chunk.text:
                            full_response += chunk.text
                            st.markdown(chunk.text)  # é¡¯ç¤ºé€æ®µå›æ‡‰

                except requests.exceptions.Timeout:
                    st.error("â° è«‹æ±‚é€¾æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚")
                except Exception as e:
                    st.error(f"âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š{e}")
